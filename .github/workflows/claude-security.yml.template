# Claude Code Security Review Workflow
#
# Automated security scanning using Claude Code's security-guidance plugin.
# Provides AI-powered vulnerability detection and security recommendations.
#
# Based on: https://github.com/anthropics/claude-code-security-review
#
# Features:
# - Vulnerability pattern detection
# - Security best practices validation
# - Dependency security analysis
# - Actionable remediation guidance
#
# Setup:
# 1. Add ANTHROPIC_API_KEY to repository secrets
# 2. Configure security scanning rules (optional)
# 3. Set up security alerts routing

name: Claude Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
  schedule:
    # Run daily security scan at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# Limit to one security scan at a time per PR
concurrency:
  group: claude-security-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security-scan:
    name: Security Scan with Claude
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for security context
          
      - name: Setup Claude Code
        uses: anthropics/claude-code-security-review@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Run security analysis
        id: security
        uses: anthropics/claude-code-security-review@v1
        with:
          scan-type: comprehensive
          severity-threshold: medium
          
      - name: Upload security findings
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-results.sarif
          category: claude-security
          
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const findings = `${{ steps.security.outputs.summary }}`;
            const severity = `${{ steps.security.outputs.max_severity }}`;
            
            let emoji = '‚úÖ';
            if (severity === 'high' || severity === 'critical') emoji = 'üö®';
            else if (severity === 'medium') emoji = '‚ö†Ô∏è';
            
            const comment = `${emoji} **Security Scan Results**\n\n${findings}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: Fail on critical vulnerabilities
        if: steps.security.outputs.max_severity == 'critical'
        run: |
          echo "Critical security vulnerabilities found!"
          exit 1

# Template only - Uncomment and configure for production use
# Notes:
# - The anthropics/claude-code-security-review@v1 is a reference
# - Actual action may have different configuration options
# - Check https://github.com/anthropics/claude-code-security-review for latest docs
# - May need different setup steps depending on actual action implementation
