# Claude Code PR Review Workflow
#
# Automated PR review using Claude Code's code-review plugin.
# Provides comprehensive code analysis, security checks, and actionable feedback.
#
# Based on: https://github.com/anthropics/claude-code-action
#
# Features:
# - Multi-agent review with confidence scoring
# - Security vulnerability detection
# - Code quality and style analysis
# - Automated comment posting
#
# Setup:
# 1. Add ANTHROPIC_API_KEY to repository secrets
# 2. Configure GITHUB_TOKEN permissions (automatic)
# 3. Customize review criteria in the plugin configuration

name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

# Limit to one review per PR at a time
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: Review with Claude
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
          
      - name: Setup Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          
      - name: Run code review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          command: /review-pr-ci
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ github.event.pull_request.number }}
          
      - name: Post review results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.review.outputs.summary }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

# Template only - Uncomment and configure for production use
# Notes:
# - The anthropics/claude-code-action@v1 is a reference
# - Actual action may have different configuration options
# - Check https://github.com/anthropics/claude-code-action for latest docs
# - May need to install Claude Code CLI in setup step instead of using action
