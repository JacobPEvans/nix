# Validate Claude Code Settings
#
# Validates Claude Code settings files against JSON Schema to prevent
# configuration errors that break permissions.
#
# Triggers: Changes to Claude config files or permission definitions
# Schema: https://github.com/spences10/claude-code-settings-schema

name: Validate Claude Settings

on:
  push:
    branches: [main]
    paths:
      - '.claude/**'
      - 'modules/home-manager/ai-cli/**'
  pull_request:
    paths:
      - '.claude/**'
      - 'modules/home-manager/ai-cli/**'

jobs:
  validate:
    name: Validate settings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3

      - name: Fetch schema
        run: |
          curl -sL https://raw.githubusercontent.com/spences10/claude-code-settings-schema/main/claude-code-settings.schema.json \
            -o claude-code-settings.schema.json

      - name: Extract settings via nix eval
        run: |
          # Use nix eval to extract the settings.json content without building
          # This avoids cross-platform build issues (darwin config on Linux runner)
          nix eval --raw '.#darwinConfigurations.default.config.home-manager.users.jevans.home.file.".claude/settings.json".text' \
            > settings-generated.json

      - name: Validate settings files
        run: |
          nix-shell -p check-jsonschema --run '
            echo "Validating Claude Code settings..."
            check-jsonschema --schemafile claude-code-settings.schema.json settings-generated.json
            echo "Settings validation passed!"
          '
